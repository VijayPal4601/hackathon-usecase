name: Build and Push to GCR

on:
  push:
    branches: [ main ]

jobs:
  terraform:
    name: Create GCR
    runs-on: ubuntu-latest

    outputs:
      registry_url: ${{ steps.tfout.outputs.registry }}

    steps:
    - uses: actions/checkout@v4

    - name: Auth to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply
      working-directory: terraform
      run: |
        terraform apply -auto-approve \
          -var="project_id=${{ secrets.GCP_PROJECT_ID }}"

    - name: Terraform Output
      id: tfout
      working-directory: terraform
      run: |
        echo "registry=$(terraform output -raw registry_url)" >> $GITHUB_OUTPUT
